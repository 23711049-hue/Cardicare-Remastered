<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardiCare | Patient Portal</title>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL --- */
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; margin: 0; }
        .app-container { display: flex; height: 100vh; width: 100%; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; min-width: 260px;
            background-color: #1e293b !important;
            padding: 1.5rem; padding-top: 1rem;
            display: flex; flex-direction: column; justify-content: flex-start;
            border-right: 1px solid rgba(255,255,255,0.1);
            height: 100vh; z-index: 100; box-sizing: border-box;
        }
        .logo-area { margin-bottom: 1.5rem; margin-top: 0.5rem; }
        .logo-area h1 { font-size: 1.4rem; margin: 0; color: #ffffff !important; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .nav-menu { display: flex; flex-direction: column; gap: 5px; }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 10px 15px;
            color: #e2e8f0 !important; text-decoration: none; border-radius: 10px;
            cursor: pointer; font-size: 0.95rem; transition: background 0.2s;
        }
        .nav-item:hover { background-color: rgba(255,255,255,0.1) !important; color: #ffffff !important; }
        .nav-item.active { background-color: #10B981 !important; color: #ffffff !important; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        /* Khusus tombol emergency aktif warnanya merah */
        .nav-item#nav-emergency.active { background-color: #ef4444 !important; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
        .separator { margin: 1rem 0 0.5rem 10px; font-size: 0.7rem; color: #94a3b8; font-weight: 800; letter-spacing: 1px; }

        /* --- CONTENT --- */
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; position: relative; background: radial-gradient(circle at top right, rgba(16,185,129,0.1), transparent 40%); }
        .user-greeting h2 { font-size: 1.5rem; margin: 0; }
        .user-greeting p { color: #94a3b8; margin-top: 5px; font-size: 0.9rem; }

        /* --- MOBILE --- */
        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 2000; background: #10B981; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-size: 1.2rem; cursor: pointer; align-items: center; justify-content: center; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99; backdrop-filter: blur(5px); }

        @media (max-width: 768px) {
            .mobile-menu-btn { display: flex; }
            .sidebar { position: fixed; top: 0; left: -100%; height: 100vh; width: 260px; transition: 0.3s; box-shadow: 5px 0 25px rgba(0,0,0,0.9); padding-top: 2rem; }
            .sidebar.active { left: 0; }
            .sidebar-overlay.active { display: block; }
            .main-content { padding-top: 80px; padding-left: 1.5rem; padding-right: 1.5rem; }
            .scanner-layout { grid-template-columns: 1fr !important; }
        }

        /* --- MODULE STYLES --- */
        .module-section { display: none; animation: fadeIn 0.5s ease; margin-top: 2rem; }
        .active-module { display: block; }
        
        /* Nutri Guard */
        .scanner-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem; }
        .glass-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 2rem; }
        .upload-zone { text-align: center; border: 2px dashed rgba(255,255,255,0.2); cursor: pointer; transition: 0.3s; min-height: 300px; display: flex; align-items: center; justify-content: center; flex-direction: column; background: rgba(255,255,255,0.02); }
        .upload-zone:hover { border-color: #10B981; background: rgba(16, 185, 129, 0.05); }

        /* Chat Interface */
        .chat-interface { display: flex; flex-direction: column; height: 550px; background: rgba(30, 41, 59, 0.5); border-radius: 16px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); margin-top: 1rem; }
        .chat-container { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .message { display: flex; align-items: flex-start; gap: 10px; max-width: 85%; }
        .message.bot-message { align-self: flex-start; }
        .message.user-message { align-self: flex-end; flex-direction: row-reverse; }
        .msg-avatar { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.9rem; }
        .bot-message .msg-avatar { background: #10B981; color: white; }
        .user-message .msg-avatar { background: #60A5FA; color: white; }
        .msg-content { padding: 12px 16px; border-radius: 12px; font-size: 0.95rem; line-height: 1.5; }
        .bot-message .msg-content { background: rgba(255,255,255,0.1); color: #e2e8f0; border-top-left-radius: 2px; }
        .user-message .msg-content { background: #2563EB; color: white; border-top-right-radius: 2px; }
        .input-area { padding: 1rem; background: rgba(15, 23, 42, 0.6); display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .input-area input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 12px 20px; border-radius: 30px; color: white; outline: none; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: #10B981; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* --- EMERGENCY TAB STYLES (NEW) --- */
        .emergency-header { background: linear-gradient(135deg, rgba(220, 38, 38, 0.2), rgba(30, 41, 59, 0.9)); border: 1px solid #ef4444; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; text-align: center; position: relative; overflow: hidden; }
        .pulse-ring { position: absolute; width: 200px; height: 200px; border-radius: 50%; background: rgba(239, 68, 68, 0.2); top: 50%; left: 50%; transform: translate(-50%, -50%); animation: pulse 2s infinite; z-index: 0; }
        .emergency-content { position: relative; z-index: 1; }
        
        .hospital-list { display: flex; flex-direction: column; gap: 1rem; }
        .hospital-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .hospital-card:hover { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
        .hospital-info h4 { margin: 0 0 5px 0; font-size: 1.1rem; color: white; }
        .hospital-info p { margin: 0; font-size: 0.9rem; color: #94a3b8; }
        .badges { display: flex; gap: 8px; margin-top: 8px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .badge-cath { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid #10b981; }
        .badge-bpjs { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid #3b82f6; }
        
        .distance-box { text-align: right; }
        .dist-val { font-size: 1.2rem; font-weight: 800; color: #ef4444; }
        .dist-time { font-size: 0.8rem; color: #cbd5e1; display: block; }
        .btn-nav { margin-top: 8px; background: white; color: #0f172a; border: none; padding: 6px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.85rem; }
        .btn-nav:hover { background: #e2e8f0; }

        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.7; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars"></i>
    </button>
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="app-container">
        
        <nav class="sidebar">
            <div class="logo-area">
                <h1><i class="fa-solid fa-heart-pulse" style="color: #ef4444;"></i> CardiCare</h1>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-item">
                    <i class="fa-solid fa-house"></i> Dashboard
                </a>
                
                <div class="separator">PERSONAL HEALTH</div>
                
                <a class="nav-item active" id="nav-nutri" onclick="switchTab('nutri')">
                    <i class="fa-solid fa-apple-whole"></i> Nutri-Guard
                </a>
                
                <a class="nav-item" id="nav-meds" onclick="switchTab('meds')">
                    <i class="fa-solid fa-user-doctor"></i> Med-Shield Chat
                </a>
                
                <div class="separator" style="color:#ef4444;">URGENT</div>
                <a class="nav-item" id="nav-emergency" onclick="switchTab('emergency')">
                    <i class="fa-solid fa-truck-medical" style="color:#ef4444;"></i> Emergency RS
                </a>
            </div>
        </nav>

        <main class="main-content">
            
            <header style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 class="user-greeting">Patient Engine</h2>
                    <p style="color: #94a3b8; font-size: 0.9rem;">AI-Powered Daily Health Assistant</p>
                </div>
                <div style="background: rgba(16,185,129,0.1); color: #10b981; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; border: 1px solid rgba(16,185,129,0.2);">
                    ‚óè ONLINE
                </div>
            </header>

            <section id="nutri-tab" class="module-section active-module">
                <div class="scanner-layout">
                    <div class="glass-card upload-zone" onclick="document.getElementById('foodInput').click()">
                        <input type="file" id="foodInput" accept="image/*" hidden onchange="handleFoodUpload(this)">
                        <div class="upload-content">
                            <div style="font-size: 3rem; color: #64748b; margin-bottom: 1rem;"><i class="fa-solid fa-camera"></i></div>
                            <h3>Scan Makanan</h3>
                            <p style="color:#94a3b8; font-size:0.9rem;">Upload foto untuk analisa nutrisi</p>
                        </div>
                        <div id="scanPreview" style="display:none; width:100%; text-align:center;">
                            <img id="previewImg" src="" style="max-width:100%; max-height:250px; border-radius:10px;">
                            <p class="scanning-text" style="color:#10B981; margin-top:10px;"><i class="fa-solid fa-spinner fa-spin"></i> Analyzing...</p>
                        </div>
                    </div>
                    <div class="glass-card result-zone" id="nutriResult">
                        <div style="text-align:center; color:#64748b; padding-top:4rem;">
                            <i class="fa-solid fa-utensils" style="font-size:3rem; margin-bottom:1rem;"></i>
                            <p>Hasil analisa akan muncul di sini</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="meds-tab" class="module-section">
                <div style="margin-bottom: 1rem;">
                    <h3 style="margin:0; font-size:1.2rem;"><i class="fa-solid fa-user-doctor" style="color:#60A5FA;"></i> MedShield Pharmacist</h3>
                    <p style="color: #94a3b8; font-size: 0.9rem;">Konsultasi keamanan dan interaksi obat instan.</p>
                </div>
                <div class="chat-interface">
                    <div id="chat-container" class="chat-container">
                        <div class="message bot-message">
                            <div class="msg-avatar"><i class="fa-solid fa-robot"></i></div>
                            <div class="msg-content">Halo! Obat apa yang ingin Anda cek keamanannya hari ini? üíä</div>
                        </div>
                    </div>
                    <div class="input-area">
                        <input type="text" id="drugInput" placeholder="Ketik nama obat..." onkeypress="handleEnter(event)">
                        <button onclick="sendDrugConsultation()" class="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </section>

            <section id="emergency-tab" class="module-section">
                
                <div class="emergency-header">
                    <div class="pulse-ring"></div>
                    <div class="emergency-content">
                        <h2 style="color:#ef4444; margin:0;"><i class="fa-solid fa-triangle-exclamation"></i> CATH LAB LOCATOR</h2>
                        <p style="color:#cbd5e1; margin-top:5px;">Mendeteksi Rumah Sakit dengan Fasilitas PCI (Ring Jantung) Terdekat</p>
                        <button onclick="findNearestHospital()" style="background:#ef4444; color:white; border:none; padding:10px 20px; border-radius:30px; font-weight:bold; margin-top:1rem; cursor:pointer;">
                            <i class="fa-solid fa-location-crosshairs"></i> Refresh Lokasi Saya
                        </button>
                    </div>
                </div>

                <h4 style="margin-bottom:1rem; color:#94a3b8;">Rekomendasi RS (Berdasarkan GPS)</h4>
                
                <div id="hospital-list" class="hospital-list">
                    <div style="text-align:center; padding:2rem; color:#64748b;">
                        <i class="fa-solid fa-satellite-dish fa-spin" style="font-size:2rem; margin-bottom:1rem;"></i>
                        <p>Mencari RS dengan fasilitas Cath Lab...</p>
                    </div>
                </div>

            </section>

        </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/gemini.js"></script>
    
    <script>
        // --- MOBILE SIDEBAR ---
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        // --- TAB SWITCHER ---
        function switchTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.module-section').forEach(el => el.classList.remove('active-module'));

            document.getElementById(tabName + '-tab').classList.add('active-module');
            document.getElementById('nav-' + tabName).classList.add('active');
            
            if(tabName === 'emergency') findNearestHospital(); // Auto scan saat buka tab emergency
            if(window.innerWidth < 768) toggleSidebar();
        }

        // --- EMERGENCY LOGIC (CATH LAB LOCATOR) ---
        function findNearestHospital() {
            const list = document.getElementById('hospital-list');
            list.innerHTML = `<div style="text-align:center; padding:2rem; color:#64748b;"><i class="fa-solid fa-satellite-dish fa-spin" style="font-size:2rem; margin-bottom:1rem;"></i><p>Mencari RS dengan fasilitas Cath Lab...</p></div>`;

            // Simulasi Delay GPS
            setTimeout(() => {
                // DATA DUMMY RS (Bisa diganti Real Data nanti)
                const hospitals = [
                    { name: "RS Jantung Harapan Kita", type: "Pusat Jantung Nasional", dist: 2.4, time: 12, cath: true, bpjs: true },
                    { name: "RSUD Dr. Moewardi", type: "RSUD Rujukan Utama", dist: 4.1, time: 18, cath: true, bpjs: true },
                    { name: "RS Panti Waluyo", type: "RS Swasta", dist: 1.2, time: 5, cath: false, bpjs: true }, // Tidak punya Cath Lab
                    { name: "RS Indriati", type: "RS Swasta Spesialis", dist: 8.5, time: 25, cath: true, bpjs: true }
                ];

                // Filter hanya yang punya Cath Lab (Prioritas Penanganan Jantung)
                const recommended = hospitals.filter(h => h.cath).sort((a,b) => a.dist - b.dist);

                let html = "";
                recommended.forEach(h => {
                    html += `
                    <div class="hospital-card">
                        <div class="hospital-info">
                            <h4>${h.name} <i class="fa-solid fa-circle-check" style="color:#10b981; font-size:0.8rem;" title="Verified Cath Lab"></i></h4>
                            <p>${h.type}</p>
                            <div class="badges">
                                <span class="badge badge-cath">CATH LAB AVAILABLE</span>
                                ${h.bpjs ? '<span class="badge badge-bpjs">TERIMA BPJS</span>' : ''}
                            </div>
                        </div>
                        <div class="distance-box">
                            <div class="dist-val">${h.dist} km</div>
                            <span class="dist-time">~${h.time} mnt</span>
                            <button class="btn-nav" onclick="window.open('https://www.google.com/maps/search/${h.name}', '_blank')">
                                <i class="fa-solid fa-location-arrow"></i> NAVIGATE
                            </button>
                        </div>
                    </div>`;
                });
                
                // Tambahkan Warning untuk RS Non-Cath Lab
                html += `<div style="margin-top:2rem; padding:1rem; border:1px dashed #64748b; border-radius:10px; color:#94a3b8; font-size:0.85rem; text-align:center;">
                    <i class="fa-solid fa-circle-info"></i> RS lain mungkin lebih dekat, namun sistem memprioritaskan RS dengan fasilitas <b>Intervensi Koroner (PCI)</b> untuk penanganan serangan jantung.
                </div>`;

                list.innerHTML = html;
            }, 1500);
        }

        // --- CHATBOT & NUTRI LOGIC (SAMA SEPERTI SEBELUMNYA) ---
        function handleEnter(e) { if (e.key === 'Enter') sendDrugConsultation(); }
        async function sendDrugConsultation() {
            const input = document.getElementById('drugInput');
            const text = input.value.trim();
            if(!text) return;
            appendMessage(text, 'user');
            input.value = '';
            const loadingId = appendLoading();
            scrollToBottom();
            try {
                if(typeof askGeminiChat === 'function') {
                    const reply = await askGeminiChat(text);
                    removeMessage(loadingId);
                    appendMessage(reply, 'bot');
                } else { throw new Error("API Missing"); }
            } catch (err) { removeMessage(loadingId); appendMessage("‚ö†Ô∏è Maaf, Apoteker AI offline.", 'bot'); }
            scrollToBottom();
        }
        function appendMessage(text, sender) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `message ${sender}-message`;
            div.innerHTML = `<div class="msg-avatar"><i class="fa-solid ${sender==='bot'?'fa-robot':'fa-user'}"></i></div><div class="msg-content">${text}</div>`;
            container.appendChild(div);
        }
        function appendLoading() {
            const container = document.getElementById('chat-container');
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id; div.className = 'message bot-message';
            div.innerHTML = `<div class="msg-avatar"><i class="fa-solid fa-robot"></i></div><div class="msg-content"><i class="fa-solid fa-circle-notch fa-spin"></i> Mengecek...</div>`;
            container.appendChild(div); return id;
        }
        function removeMessage(id) { const el = document.getElementById(id); if(el) el.remove(); }
        function scrollToBottom() { const el = document.getElementById('chat-container'); el.scrollTop = el.scrollHeight; }

        function handleFoodUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    document.querySelector('.upload-content').style.display = 'none';
                    document.getElementById('scanPreview').style.display = 'block';
                    document.getElementById('previewImg').src = e.target.result;
                    const base64 = e.target.result.split(',')[1];
                    try {
                        const res = await askGeminiVision(base64, 'food');
                        renderNutriResult(res);
                        document.querySelector('.scanning-text').innerHTML = '‚úÖ SELESAI';
                    } catch(e) { alert("Gagal scan makanan"); }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function renderNutriResult(data) {
            const box = document.getElementById('nutriResult');
            let color = data.status === 'danger' ? '#ef4444' : (data.status === 'moderate' ? '#f59e0b' : '#10b981');
            box.innerHTML = `<div style="text-align:center; padding-top:1rem;"><h2 style="color:${color}">${data.food_name}</h2><div style="display:flex; justify-content:center; gap:20px; margin:1rem 0;"><div style="background:#334155; padding:10px; border-radius:10px;">Calories: <b>${data.calories}</b></div><div style="background:#334155; padding:10px; border-radius:10px;">Sodium: <b style="color:${color}">${data.sodium}</b></div></div><p style="background:rgba(255,255,255,0.1); padding:1rem; border-radius:10px;">${data.advice}</p></div>`;
        }
    </script>
</body>
</html>
<script src="js/config.js"></script>
    <script src="js/gemini.js"></script>
    
    <script>
        // --- MOBILE SIDEBAR ---
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        // --- TAB SWITCHER ---
        function switchTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.module-section').forEach(el => el.classList.remove('active-module'));

            document.getElementById(tabName + '-tab').classList.add('active-module');
            document.getElementById('nav-' + tabName).classList.add('active');
            
            // Auto-trigger GPS kalau masuk tab emergency
            if(tabName === 'emergency') findNearestHospital(); 
            
            if(window.innerWidth < 768) toggleSidebar();
        }

        // ============================================================
        //  üè• REAL-TIME CATH LAB LOCATOR (PILMAPRES EDITION)
        // ============================================================
        
        // 1. DATABASE KOORDINAT RS RUJUKAN JANTUNG (DATA ASLI)
        // Tips: Karena Pilmapres UII (Jogja), saya perbanyak data Jogja & Jateng
        const hospitalDB = [
            // JOGJA
            { name: "RSUP Dr. Sardjito", type: "Pusat Rujukan Nasional", lat: -7.7686, lng: 110.3736, cath: true, bpjs: true },
            { name: "RS JIH (Jogja International)", type: "RS Swasta Premium", lat: -7.7566, lng: 110.4034, cath: true, bpjs: true },
            { name: "RS Bethesda Yogyakarta", type: "RS Swasta Utama", lat: -7.7839, lng: 110.3776, cath: true, bpjs: true },
            { name: "RS PKU Muhammadiyah Gamping", type: "RS Swasta", lat: -7.8003, lng: 110.3167, cath: true, bpjs: true },
            
            // SOLO & JATENG
            { name: "RSUD Dr. Moewardi Solo", type: "Rujukan Jawa Tengah", lat: -7.5563, lng: 110.8359, cath: true, bpjs: true },
            { name: "RS Dr. Kariadi Semarang", type: "Pusat Rujukan Jateng", lat: -6.9934, lng: 110.4087, cath: true, bpjs: true },
            
            // JAKARTA (Nasional)
            { name: "RS Jantung Harapan Kita", type: "Pusat Jantung Nasional", lat: -6.1843, lng: 106.7979, cath: true, bpjs: true },
            { name: "RSPAD Gatot Soebroto", type: "RS Kepresidenan", lat: -6.1764, lng: 106.8375, cath: true, bpjs: true },
            
            // JATIM
            { name: "RSUD Dr. Soetomo", type: "Rujukan Jawa Timur", lat: -7.2694, lng: 112.7584, cath: true, bpjs: true }
        ];

        // 2. FUNGSI UTAMA: CARI LOKASI
        function findNearestHospital() {
            const list = document.getElementById('hospital-list');
            list.innerHTML = `
                <div style="text-align:center; padding:3rem; color:#64748b;">
                    <i class="fa-solid fa-satellite-dish fa-spin" style="font-size:3rem; color:#ef4444; margin-bottom:1rem;"></i>
                    <h3 style="margin:0; color:white;">Mengakses Satelit GPS...</h3>
                    <p>Mencari fasilitas Cath Lab terdekat dari posisi Anda.</p>
                </div>`;

            // Cek Support Browser
            if (!navigator.geolocation) {
                alert("Browser Anda tidak mendukung Geolocation.");
                return;
            }

            // Minta Akses GPS
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    // Hitung Jarak ke Semua RS
                    const results = hospitalDB.map(h => {
                        const dist = calculateDistance(userLat, userLng, h.lat, h.lng);
                        return { ...h, distance: dist };
                    });

                    // Urutkan dari yang Terdekat (ASCENDING)
                    results.sort((a, b) => a.distance - b.distance);

                    // Ambil 3 Terdekat
                    const top3 = results.slice(0, 3);
                    renderHospitals(top3, userLat, userLng);
                },
                (error) => {
                    // Error Handling (Kalau user tolak akses/GPS mati)
                    list.innerHTML = `
                        <div style="text-align:center; padding:2rem; color:#ef4444; border:1px dashed #ef4444; border-radius:10px;">
                            <i class="fa-solid fa-location-slash" style="font-size:2rem; margin-bottom:10px;"></i>
                            <p><b>Akses Lokasi Ditolak.</b><br>Mohon aktifkan GPS untuk fitur darurat ini.</p>
                            <button onclick="findNearestHospital()" style="margin-top:10px; padding:5px 15px; cursor:pointer;">Coba Lagi</button>
                        </div>`;
                },
                { enableHighAccuracy: true } // Minta akurasi tinggi
            );
        }

        // 3. RENDER UI (TAMPILKAN KE LAYAR)
        function renderHospitals(hospitals, uLat, uLng) {
            const list = document.getElementById('hospital-list');
            let html = "";

            hospitals.forEach(h => {
                // Estimasi Waktu (Asumsi kecepatan rata-rata ambulans 40km/jam di kota)
                const timeEst = Math.ceil((h.distance / 40) * 60); 
                
                // Link Google Maps Asli (Directions)
                const gmapsLink = `https://www.google.com/maps/dir/${uLat},${uLng}/${h.lat},${h.lng}`;

                html += `
                <div class="hospital-card" style="animation: slideIn 0.5s ease;">
                    <div class="hospital-info">
                        <h4 style="margin:0 0 5px 0; font-size:1.1rem; color:white;">
                            ${h.name} <i class="fa-solid fa-circle-check" style="color:#10b981;" title="Verified"></i>
                        </h4>
                        <p style="font-size:0.85rem; color:#94a3b8; margin-bottom:8px;">${h.type}</p>
                        <div class="badges">
                            <span class="badge badge-cath" style="background:rgba(239,68,68,0.2); color:#ef4444; border:1px solid #ef4444; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold;">
                                <i class="fa-solid fa-heart-pulse"></i> CATH LAB READY
                            </span>
                            ${h.bpjs ? '<span class="badge" style="background:rgba(59,130,246,0.2); color:#3b82f6; border:1px solid #3b82f6; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold;">BPJS</span>' : ''}
                        </div>
                    </div>
                    <div class="distance-box" style="text-align:right;">
                        <div class="dist-val" style="font-size:1.4rem; font-weight:800; color:#ef4444;">${h.distance.toFixed(1)} km</div>
                        <span class="dist-time" style="font-size:0.8rem; color:#cbd5e1; display:block; margin-bottom:8px;">~${timeEst} menit</span>
                        
                        <a href="${gmapsLink}" target="_blank" style="text-decoration:none;">
                            <button class="btn-nav" style="background:white; color:#0f172a; border:none; padding:8px 15px; border-radius:20px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:5px; font-size:0.8rem; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
                                <i class="fa-solid fa-location-arrow"></i> NAVIGATE
                            </button>
                        </a>
                    </div>
                </div>`;
            });

            // Disclaimer Medis
            html += `
                <div style="margin-top:1.5rem; padding:1rem; background:rgba(245,158,11,0.1); border-left:4px solid #f59e0b; border-radius:4px; color:#cbd5e1; font-size:0.8rem; line-height:1.5;">
                    <i class="fa-solid fa-triangle-exclamation" style="color:#f59e0b;"></i> 
                    <b>Catatan Sistem:</b> Algoritma memprioritaskan RS dengan fasilitas <i>Percutaneous Coronary Intervention (PCI)</i>. Jika kondisi sangat kritis, segera kunjungi IGD terdekat manapun untuk stabilisasi awal.
                </div>`;

            list.innerHTML = html;
        }

        // 4. RUMUS MATEMATIKA: HAVERSINE (Hitung Jarak GPS)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius Bumi (km)
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Jarak dalam km
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // ============================================================
        //  END CATH LAB LOCATOR
        // ============================================================

        // --- CHATBOT & NUTRI LOGIC (EXISTING) ---
        function handleEnter(e) { if (e.key === 'Enter') sendDrugConsultation(); }
        async function sendDrugConsultation() {
            const input = document.getElementById('drugInput');
            const text = input.value.trim();
            if(!text) return;
            appendMessage(text, 'user');
            input.value = '';
            const loadingId = appendLoading();
            scrollToBottom();
            try {
                if(typeof askGeminiChat === 'function') {
                    const reply = await askGeminiChat(text);
                    removeMessage(loadingId);
                    appendMessage(reply, 'bot');
                } else { throw new Error("API Missing"); }
            } catch (err) { removeMessage(loadingId); appendMessage("‚ö†Ô∏è Maaf, Apoteker AI offline.", 'bot'); }
            scrollToBottom();
        }
        function appendMessage(text, sender) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `message ${sender}-message`;
            div.innerHTML = `<div class="msg-avatar"><i class="fa-solid ${sender==='bot'?'fa-robot':'fa-user'}"></i></div><div class="msg-content">${text}</div>`;
            container.appendChild(div);
        }
        function appendLoading() {
            const container = document.getElementById('chat-container');
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id; div.className = 'message bot-message';
            div.innerHTML = `<div class="msg-avatar"><i class="fa-solid fa-robot"></i></div><div class="msg-content"><i class="fa-solid fa-circle-notch fa-spin"></i> Mengecek...</div>`;
            container.appendChild(div); return id;
        }
        function removeMessage(id) { const el = document.getElementById(id); if(el) el.remove(); }
        function scrollToBottom() { const el = document.getElementById('chat-container'); el.scrollTop = el.scrollHeight; }

        function handleFoodUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    document.querySelector('.upload-content').style.display = 'none';
                    document.getElementById('scanPreview').style.display = 'block';
                    document.getElementById('previewImg').src = e.target.result;
                    const base64 = e.target.result.split(',')[1];
                    try {
                        const res = await askGeminiVision(base64, 'food');
                        renderNutriResult(res);
                        document.querySelector('.scanning-text').innerHTML = '‚úÖ SELESAI';
                    } catch(e) { alert("Gagal scan makanan"); }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function renderNutriResult(data) {
            const box = document.getElementById('nutriResult');
            let color = data.status === 'danger' ? '#ef4444' : (data.status === 'moderate' ? '#f59e0b' : '#10b981');
            box.innerHTML = `<div style="text-align:center; padding-top:1rem;"><h2 style="color:${color}">${data.food_name}</h2><div style="display:flex; justify-content:center; gap:20px; margin:1rem 0;"><div style="background:#334155; padding:10px; border-radius:10px;">Calories: <b>${data.calories}</b></div><div style="background:#334155; padding:10px; border-radius:10px;">Sodium: <b style="color:${color}">${data.sodium}</b></div></div><p style="background:rgba(255,255,255,0.1); padding:1rem; border-radius:10px;">${data.advice}</p></div>`;
        }
    </script>
</body>
</html>
